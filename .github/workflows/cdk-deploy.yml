name: CDK Deploy

on:
  workflow_call:
    inputs:
      aws-region:
        description: AWS region
        required: false
        type: string
        default: 'us-east-1'
      node-version:
        description: Node.js version
        required: false
        type: string
        default: '24'
      pre-build-filter:
        description: 'Turbo filter for packages to build before deploy (e.g. @my-org/shared)'
        required: false
        type: string
        default: ''
      cdk-context:
        description: 'CDK context flags (space-separated key=value pairs)'
        required: true
        type: string
      stacks:
        description: 'Stacks to deploy (default: --all)'
        required: false
        type: string
        default: '--all'
      concurrency:
        description: 'Max parallel stack deployments (default: 1)'
        required: false
        type: number
        default: 1
      method:
        description: 'Deploy method: change-set (safe, default) or direct (faster, no rollback)'
        required: false
        type: string
        default: 'change-set'
      hotswap:
        description: 'Hotswap mode: off (default), fallback (try hotswap, fall back to CFN), or force (hotswap only)'
        required: false
        type: string
        default: 'off'
      run-diff:
        description: 'Run cdk diff before deploy'
        required: false
        type: boolean
        default: true
      recover-stacks:
        description: 'Recover stuck CloudFormation stacks before deploy'
        required: false
        type: boolean
        default: true
      stack-prefix:
        description: 'Stack name prefix for recovery (required if recover-stacks is true)'
        required: false
        type: string
        default: ''
      checkout-ref:
        description: 'Git ref to checkout (defaults to triggering ref)'
        required: false
        type: string
        default: ''
    secrets:
      role-arn:
        description: 'IAM role ARN for AWS authentication'
        required: true
    outputs:
      stacks-deployed:
        description: 'Whether the deployment succeeded'
        value: ${{ jobs.deploy.outputs.deployed }}

concurrency:
  group: cdk-deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    outputs:
      deployed: ${{ steps.deploy.outcome == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref || github.ref }}

      - uses: KotaHusky/cicd-toolkit/actions/turbo-setup@v2
        with:
          node-version: ${{ inputs.node-version }}
          pre-build-filter: ${{ inputs.pre-build-filter }}

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Recover stuck stacks
        if: inputs.recover-stacks && inputs.stack-prefix != ''
        uses: KotaHusky/cicd-toolkit/actions/cfn-recover@v2
        with:
          stack-prefix: ${{ inputs.stack-prefix }}

      - name: Build CDK context flags
        id: context
        shell: bash
        run: |
          CONTEXT_FLAGS=""
          for PAIR in ${{ inputs.cdk-context }}; do
            CONTEXT_FLAGS="${CONTEXT_FLAGS} -c ${PAIR}"
          done
          echo "flags=${CONTEXT_FLAGS}" >> "$GITHUB_OUTPUT"

      # Synth once, reuse for diff + deploy (avoids double synthesis)
      - name: CDK synth
        run: npx cdk synth --quiet ${{ steps.context.outputs.flags }} -o cdk.deploy.out

      - name: CDK diff
        if: inputs.run-diff
        run: npx cdk diff --app cdk.deploy.out || true

      - name: CDK deploy
        id: deploy
        shell: bash
        run: |
          HOTSWAP_FLAG=""
          if [ "${{ inputs.hotswap }}" = "fallback" ]; then
            HOTSWAP_FLAG="--hotswap-fallback"
          elif [ "${{ inputs.hotswap }}" = "force" ]; then
            HOTSWAP_FLAG="--hotswap"
          fi

          npx cdk deploy --app cdk.deploy.out ${{ inputs.stacks }} \
            --require-approval never \
            --concurrency ${{ inputs.concurrency }} \
            --method=${{ inputs.method }} \
            ${HOTSWAP_FLAG}
