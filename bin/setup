#!/usr/bin/env bash
set -euo pipefail

# ─── cicd-toolkit setup wizard ───────────────────────────────────────────────
# Interactive setup for Azure Container Apps + Cloudflare DNS + GitHub secrets.
# Uses Bicep for Azure infrastructure, gh CLI for secrets, Cloudflare API for DNS.
# Prerequisites: az, gh (and optionally gum for a nicer UX).
# Usage: ./bin/setup

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BICEP_FILE="${SCRIPT_DIR}/../infra/main.bicep"

BOLD="\033[1m"
DIM="\033[2m"
CYAN="\033[36m"
GREEN="\033[32m"
YELLOW="\033[33m"
RED="\033[31m"
RESET="\033[0m"

HAS_GUM=false
command -v gum &>/dev/null && HAS_GUM=true

# ─── UI helpers ──────────────────────────────────────────────────────────────

header() { echo -e "\n${BOLD}${CYAN}▸ $1${RESET}"; }
success() { echo -e "${GREEN}✔ $1${RESET}"; }
warn() { echo -e "${YELLOW}⚠ $1${RESET}"; }
fail() { echo -e "${RED}✖ $1${RESET}"; exit 1; }
info() { echo -e "${DIM}  $1${RESET}"; }

confirm() {
  local prompt="$1"
  if $HAS_GUM; then
    gum confirm "$prompt" && return 0 || return 1
  else
    read -rp "$prompt [y/N] " yn
    [[ "$yn" =~ ^[Yy]$ ]]
  fi
}

input() {
  local prompt="$1" default="${2:-}"
  if $HAS_GUM; then
    gum input --placeholder "$prompt" --value "$default"
  else
    read -rp "$prompt${default:+ [$default]}: " val
    echo "${val:-$default}"
  fi
}

choose() {
  local prompt="$1"
  shift
  if $HAS_GUM; then
    gum choose --header "$prompt" "$@"
  else
    echo "$prompt" >&2
    select opt in "$@"; do
      [[ -n "$opt" ]] && echo "$opt" && break
    done
  fi
}

password() {
  local prompt="$1"
  if $HAS_GUM; then
    gum input --password --placeholder "$prompt"
  else
    read -rsp "$prompt: " val; echo >&2; echo "$val"
  fi
}

# ─── Prerequisite checks ────────────────────────────────────────────────────

check_prereqs() {
  header "Checking prerequisites"
  local missing=()
  command -v az &>/dev/null  || missing+=("az (Azure CLI)")
  command -v gh &>/dev/null  || missing+=("gh (GitHub CLI)")
  command -v jq &>/dev/null  || missing+=("jq")
  command -v curl &>/dev/null || missing+=("curl")

  if [[ ${#missing[@]} -gt 0 ]]; then
    fail "Missing required tools: ${missing[*]}"
  fi
  success "az, gh, jq, curl found"

  if $HAS_GUM; then
    success "gum found (nice UX enabled)"
  else
    info "Install 'gum' for a nicer experience: brew install gum"
  fi

  # Check Bicep template exists
  [[ -f "$BICEP_FILE" ]] || fail "Bicep template not found: $BICEP_FILE"

  # Check logins
  az account show &>/dev/null || fail "Not logged in to Azure. Run: az login"
  gh auth status &>/dev/null  || fail "Not logged in to GitHub. Run: gh auth login"
  success "Authenticated to Azure and GitHub"
}

# ─── Azure setup (Bicep) ────────────────────────────────────────────────────

setup_azure() {
  header "Azure Container Apps setup (Bicep)"

  # Subscription
  local sub_id sub_name
  sub_id=$(az account show --query id -o tsv)
  sub_name=$(az account show --query name -o tsv)
  info "Using subscription: $sub_name ($sub_id)"
  confirm "Use this subscription?" || fail "Switch subscription with: az account set -s <id>"

  # Resource group
  header "Resource group"
  local rg_action
  rg_action=$(choose "Create new or use existing resource group?" "Create new" "Use existing")
  local rg_name rg_location
  if [[ "$rg_action" == "Create new" ]]; then
    rg_name=$(input "Resource group name" "rg-homepage")
    rg_location=$(input "Azure region" "eastus")
    info "Creating resource group..."
    az group create --name "$rg_name" --location "$rg_location" -o none
    success "Created resource group: $rg_name"
  else
    rg_name=$(az group list --query "[].name" -o tsv | choose "Select resource group:")
    rg_location=$(az group show --name "$rg_name" --query location -o tsv)
    success "Using resource group: $rg_name ($rg_location)"
  fi

  # Collect parameters
  header "Bicep deployment parameters"
  local env_name
  env_name=$(input "Container Apps environment name" "aca-env")
  local identity_name
  identity_name=$(input "Managed identity name" "github-actions-oidc")

  # Collect GitHub repos
  local repos=()
  info "Add GitHub repos that will deploy to this environment."
  local add_more=true
  while $add_more; do
    local repo
    repo=$(input "GitHub repo (owner/name)" "")
    [[ -n "$repo" ]] && repos+=("$repo")
    confirm "Add another repo?" && add_more=true || add_more=false
  done
  [[ ${#repos[@]} -gt 0 ]] || fail "At least one GitHub repo is required"

  # Build JSON array for Bicep parameter
  local repos_json
  repos_json=$(printf '%s\n' "${repos[@]}" | jq -R . | jq -sc .)

  # Deploy Bicep
  header "Deploying infrastructure via Bicep"
  info "Template: $BICEP_FILE"
  info "Resource group: $rg_name"
  info "Repos: ${repos[*]}"
  echo ""

  local deploy_output
  deploy_output=$(az deployment group create \
    --resource-group "$rg_name" \
    --template-file "$BICEP_FILE" \
    --parameters \
      environmentName="$env_name" \
      identityName="$identity_name" \
      location="$rg_location" \
      githubRepos="$repos_json" \
    --query "properties.outputs" \
    -o json)

  success "Bicep deployment complete"

  # Extract outputs
  local client_id tenant_id subscription_id aca_env_name aca_domain
  client_id=$(echo "$deploy_output" | jq -r '.clientId.value')
  tenant_id=$(echo "$deploy_output" | jq -r '.tenantId.value')
  subscription_id=$(echo "$deploy_output" | jq -r '.subscriptionId.value')
  aca_env_name=$(echo "$deploy_output" | jq -r '.acaEnvironmentName.value')
  aca_domain=$(echo "$deploy_output" | jq -r '.acaDefaultDomain.value')

  echo ""
  success "Infrastructure deployed"
  info "ACA environment: $aca_env_name"
  info "ACA domain:      $aca_domain"
  info "Client ID:       $client_id"
  info "Tenant ID:       $tenant_id"
  info "Subscription ID: $subscription_id"

  # Set GitHub secrets on each repo
  header "Setting GitHub secrets"
  for repo in "${repos[@]}"; do
    if confirm "Set Azure secrets on $repo?"; then
      gh secret set AZURE_CLIENT_ID --repo "$repo" --body "$client_id"
      gh secret set AZURE_TENANT_ID --repo "$repo" --body "$tenant_id"
      gh secret set AZURE_SUBSCRIPTION_ID --repo "$repo" --body "$subscription_id"
      success "Set AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID on $repo"
    fi
  done

  # Export for use by other steps
  export AZURE_RG="$rg_name"
  export AZURE_LOCATION="$rg_location"
  export AZURE_ACA_ENV="$aca_env_name"
  export AZURE_ACA_DOMAIN="$aca_domain"
  export AZURE_CLIENT_ID="$client_id"
}

# ─── Cloudflare setup ────────────────────────────────────────────────────────

setup_cloudflare() {
  header "Cloudflare setup"

  info "You need a Cloudflare API token with Zone:DNS:Edit and Zone:Cache Purge permissions."
  info "Create one at: https://dash.cloudflare.com/profile/api-tokens"
  echo ""
  local cf_token
  cf_token=$(password "Cloudflare API token")

  # Verify token
  local verify
  verify=$(curl -sf "https://api.cloudflare.com/client/v4/user/tokens/verify" \
    -H "Authorization: Bearer $cf_token" | jq -r '.success')
  [[ "$verify" == "true" ]] || fail "Invalid Cloudflare API token"
  success "API token verified"

  # List zones and pick one
  header "Select DNS zone"
  local zones_json
  zones_json=$(curl -sf "https://api.cloudflare.com/client/v4/zones?per_page=50" \
    -H "Authorization: Bearer $cf_token" \
    -H "Content-Type: application/json")

  local zone_names
  zone_names=$(echo "$zones_json" | jq -r '.result[].name')
  [[ -n "$zone_names" ]] || fail "No zones found. Is the token scoped to a zone?"

  local zone_name
  zone_name=$(echo "$zone_names" | choose "Select your domain:")
  local zone_id
  zone_id=$(echo "$zones_json" | jq -r --arg name "$zone_name" '.result[] | select(.name==$name) | .id')
  success "Selected zone: $zone_name ($zone_id)"

  # Set GitHub secrets on repos
  header "Set Cloudflare secrets on GitHub repos"
  local add_more=true
  while $add_more; do
    local repo
    repo=$(input "GitHub repo (owner/name)" "")
    if [[ -z "$repo" ]]; then break; fi

    gh secret set CLOUDFLARE_API_TOKEN --repo "$repo" --body "$cf_token"
    gh secret set CLOUDFLARE_ZONE_ID --repo "$repo" --body "$zone_id"
    success "Set CLOUDFLARE_API_TOKEN and CLOUDFLARE_ZONE_ID on $repo"

    confirm "Add another repo?" && add_more=true || add_more=false
  done

  export CF_ZONE_NAME="$zone_name"
  export CF_ZONE_ID="$zone_id"
  export CF_TOKEN="$cf_token"

  echo ""
  success "Cloudflare setup complete"
  info "Zone: $zone_name ($zone_id)"
}

# ─── Domain mapping ─────────────────────────────────────────────────────────

setup_domain() {
  header "Custom domain mapping"

  if [[ -z "${CF_TOKEN:-}" ]]; then
    warn "Run Cloudflare setup first, or provide credentials."
    local cf_token zone_id
    cf_token=$(password "Cloudflare API token")
    zone_id=$(input "Cloudflare Zone ID" "")
    export CF_TOKEN="$cf_token"
    export CF_ZONE_ID="$zone_id"
  fi

  local subdomain
  subdomain=$(input "Subdomain to map (e.g. app.example.com)" "")
  [[ -n "$subdomain" ]] || fail "Subdomain is required"

  local target
  if [[ -n "${AZURE_ACA_DOMAIN:-}" ]]; then
    info "ACA default domain: $AZURE_ACA_DOMAIN"
  fi
  target=$(input "Target (ACA FQDN or IP)" "${AZURE_ACA_DOMAIN:-}")
  [[ -n "$target" ]] || fail "Target is required"

  local record_type
  record_type=$(choose "DNS record type:" "CNAME" "A" "AAAA")

  local proxied
  confirm "Enable Cloudflare proxy (orange cloud)?" && proxied=true || proxied=false

  # Check if record exists
  local existing
  existing=$(curl -sf \
    "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${subdomain}&type=${record_type}" \
    -H "Authorization: Bearer ${CF_TOKEN}" | jq -r '.result[0].id // empty')

  local payload
  payload=$(jq -n \
    --arg type "$record_type" \
    --arg name "$subdomain" \
    --arg content "$target" \
    --argjson proxied "$proxied" \
    '{type: $type, name: $name, content: $content, proxied: $proxied}')

  if [[ -n "$existing" ]]; then
    curl -sf -X PUT \
      "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${existing}" \
      -H "Authorization: Bearer ${CF_TOKEN}" \
      -H "Content-Type: application/json" \
      --data "$payload" | jq -r '.result | "\(.name) → \(.content) (\(.type), proxied=\(.proxied))"'
    success "Updated DNS record"
  else
    curl -sf -X POST \
      "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records" \
      -H "Authorization: Bearer ${CF_TOKEN}" \
      -H "Content-Type: application/json" \
      --data "$payload" | jq -r '.result | "\(.name) → \(.content) (\(.type), proxied=\(.proxied))"'
    success "Created DNS record"
  fi

  if [[ "$proxied" == "true" ]]; then
    echo ""
    warn "Cloudflare proxy is ON. For ACA custom domains:"
    info "1. Set Cloudflare SSL mode to Full (Strict)"
    info "2. Use a Cloudflare Origin Certificate on ACA (not ACA managed certs)"
    info "   Docs: dash.cloudflare.com → SSL/TLS → Origin Server → Create Certificate"
  fi
}

# ─── Main menu ───────────────────────────────────────────────────────────────

main() {
  echo -e "${BOLD}${CYAN}"
  echo "  ┌──────────────────────────────────┐"
  echo "  │  cicd-toolkit setup wizard        │"
  echo "  │  Azure Container Apps + Cloudflare│"
  echo "  └──────────────────────────────────┘"
  echo -e "${RESET}"

  check_prereqs

  local action
  action=$(choose "What do you want to set up?" \
    "Full setup (Azure + Cloudflare + DNS)" \
    "Azure Container Apps only" \
    "Cloudflare DNS only" \
    "Map a custom domain")

  case "$action" in
    "Full setup"*)
      setup_azure
      setup_cloudflare
      if confirm "Map a custom domain now?"; then
        setup_domain
      fi
      ;;
    "Azure Container Apps only")
      setup_azure
      ;;
    "Cloudflare DNS only")
      setup_cloudflare
      ;;
    "Map a custom domain")
      setup_domain
      ;;
  esac

  echo ""
  echo -e "${BOLD}${GREEN}Done!${RESET} Your repos are ready to deploy."
  info "Push a commit to main and the CI pipeline will handle the rest."
}

main "$@"
